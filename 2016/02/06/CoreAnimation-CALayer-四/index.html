<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="希望自己在未来的路上越走越坚定."><title>CoreAnimation-CALayer(四) | aSnail</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CoreAnimation-CALayer(四)</h1><a id="logo" href="/.">aSnail</a><p class="description">年轻就是折腾</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CoreAnimation-CALayer(四)</h1><div class="post-meta">Feb 6, 2016<span> | </span><span class="category"><a href="/categories/iOSTips/">iOSTips</a></span></div><div class="post-content"><h1 id="CoreAnimation-CALayer-四"><a href="#CoreAnimation-CALayer-四" class="headerlink" title="CoreAnimation-CALayer(四)"></a>CoreAnimation-CALayer(四)</h1><h2 id="Animation的原理"><a href="#Animation的原理" class="headerlink" title="Animation的原理"></a>Animation的原理</h2><p>我们在前面讲了在修改非根层的layer的animatable属性时会产生隐式动画,那为什么直接修改view.layer的animatable属性并不能产生动画,而是需要放在<code>+ (void)animateWithDuration:(NSTimeInterval)duration animations:(void (^)(void))animations</code>的animationBlock中才会产生动画呢?</p>
<p>前面文章讲了UIView和CALayer的关系,一个UIView内部默认有一个layer(rootLayer),layer负责绘制,view是layer的delegate.<br>其实我们在修改layer的animatable属性时,layer会调用它的delegate的<code>- (nullable id&lt;CAAction&gt;)actionForLayer:(CALayer *)layer forKey:(NSString *)event</code>方法,这个方法的返回值有三种情况</p>
<ul>
<li>返回nil</li>
<li>返回(NSNull * )对象</li>
<li><p>返回一个 (id<caaction>)的对象.</caaction></p>
<p>对这三种情况会产生三种效果:返回值为nil,就会产生<strong>隐式动画</strong>,返回值为(NSNull <em>)没有动画效果,第三种情况是使用返回的(id<caaction>)对象产生一个CAAnimation,并且调用自己的addAnimation:方法进行动画.<br>直接修改非根层layer的animatable属性属于第一种,因为这个layer没有delegate对象,该方法返回nil,所以就有了隐式动画<br>直接修改根层layer的属性又分为两种情况,第一种在animationBlock外部直接修改,这里就返回NSNull </caaction></em>,第二种在animationBlock内部修改,这里会返回(id<caaction>)产生动画,这里我们需要注意直接修改UIView的属性例如transform,其实是直接修改的它内部的layer的transform属性!<br>我们来验证一下</caaction></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CustomLayer.m</span></span><br><span class="line">@implementation CustomLayer</span><br><span class="line">- (<span class="keyword">void</span>)setPosition:(CGPoint)position &#123;</span><br><span class="line">    id action = nil;</span><br><span class="line">    <span class="keyword">if</span> ([self.delegate respondsToSelector:@selector(actionForLayer:forKey:)]) &#123;</span><br><span class="line">        action = [self.delegate actionForLayer:self forKey:@<span class="string">"positon"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (action == nil) &#123;</span><br><span class="line">        NSLog(@<span class="string">"action == nil"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> ([action isKindOfClass:[NSNull class]]) &#123;</span><br><span class="line">        NSLog(@<span class="string">"action is null"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> ([action conformsToProtocol:@protocol(CAAction)]) &#123;</span><br><span class="line">        NSLog(@<span class="string">"action conformsToProtocol:@protocol(CAAction)"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        [super setPosition:position];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"><span class="comment">//CustomView.m</span></span><br><span class="line">@implementation CustomView</span><br><span class="line">+ (Class)layerClass &#123;</span><br><span class="line">    <span class="keyword">return</span> [CustomLayer class];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"><span class="comment">//ViewController.m</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    _cV = [[CustomView alloc] initWithFrame:CGRectMake(<span class="number">50</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>)];</span><br><span class="line">    _cV.backgroundColor = [UIColor redColor];</span><br><span class="line">    [self.view addSubview:_cV];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    _cV.layer.position = CGPointMake(<span class="number">150</span>, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们这里直接修改的是根层的position,输出台打印结果是: action is null</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    _custLayer = [CustomLayer layer];</span><br><span class="line">    _custLayer.bounds = CGRectMake(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">    _custLayer.position = CGPointMake(<span class="number">300</span>, <span class="number">300</span>);</span><br><span class="line">    _custLayer.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:_custLayer];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    _custLayer.position = CGPointMake(<span class="number">350</span>, <span class="number">350</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里直接修改非根层layer的属性,打印结果是action == nil</p>
<h4 id="CALayer的-presentationLayer-和-modelLayer"><a href="#CALayer的-presentationLayer-和-modelLayer" class="headerlink" title="CALayer的 presentationLayer 和 modelLayer"></a>CALayer的 presentationLayer 和 modelLayer</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    _customView = [[UIView alloc] initWithFrame:CGRectMake(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>)];</span><br><span class="line">    _customView.backgroundColor = [UIColor redColor];</span><br><span class="line">    [self.view addSubview:_customView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    CABasicAnimation *animation = [CABasicAnimation animation];</span><br><span class="line">    animation.keyPath = @<span class="string">"position"</span>;</span><br><span class="line">    animation.duration = <span class="number">0.5</span>;</span><br><span class="line">    animation.toValue = [NSValue valueWithCGPoint:CGPointMake(<span class="number">200</span>, <span class="number">200</span>)];</span><br><span class="line">    [_customView.layer addAnimation:animation forKey:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://o7vzr7y09.bkt.clouddn.com/transform.gif" alt><br>我们看到动画完成后又回到了原来的位置,这是为什么呢?<br>在CALayer内部，它控制着两个属性：presentationLayer 展示层(以下称为P)和modelLayer（模型层以下称为M）。</p>
<p>P只负责显示，M只负责数据的存储和获取。我们对layer的各种属性赋值比如frame，<strong>实际上是直接对M的属性赋值</strong>，而P将在每一次屏幕刷新的时候回到M的状态。比如此时M的状态是1，P的状态也是1，然后我们把M的状态改为2，那么此时P还没有过去，也就是我们看到的状态P还是1，在下一次屏幕刷新的时候P才变为2。而我们几乎感知不到两次屏幕刷新之间的间隙，所以感觉就是我们一对M赋值，P就过去了。P就像是瞎子，M就像是瘸子，瞎子背着瘸子，瞎子每走一步（也就是每次屏幕刷新的时候）都要去问瘸子应该怎样走（这里的走路就是绘制内容到屏幕上），瘸子没法走，只能指挥瞎子背着自己走。可以简单的理解为：一般情况下，任意时刻P都会回到M的状态。</p>
<p>而当一个CAAnimation（以下称为A）加到了layer上面后，A就把M从P身上挤下去了。现在P背着的是A，P同样在每次屏幕刷新的时候去问他背着的那个家伙，A就指挥它从fromValue到toValue来改变值。而动画结束后，A会自动被移除，这时P没有了指挥，就只能大喊“M你在哪”，M说我还在原地没动呢，于是P就顺声回到M的位置了。这就是为什么动画结束后我们看到这个视图又回到了原来的位置，是因为我们看到在移动的是P，而指挥它移动的是A，M永远停在原来的位置没有动，动画结束后A被移除，P就回到了M的怀里。</p>
<p>我们不想动画完成以后再回到原来位置怎么办呢?<code>CAAniamtion</code>基类中提供了<code>removedOnCompletion</code>,这个属性默认是YES,我们需要将它置为NO,同时将<code>fillMode</code>设置为<code>kCAFillModeForwards</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    CABasicAnimation *animation = [CABasicAnimation animation];</span><br><span class="line">    animation.keyPath = @<span class="string">"position"</span>;</span><br><span class="line">    animation.duration = <span class="number">0.5</span>;</span><br><span class="line">    animation.removedOnCompletion = NO;</span><br><span class="line">    animation.fillMode = kCAFillModeForwards;</span><br><span class="line">    animation.toValue = [NSValue valueWithCGPoint:CGPointMake(<span class="number">200</span>, <span class="number">200</span>)];</span><br><span class="line">    [_customView.layer addAnimation:animation forKey:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://o7vzr7y09.bkt.clouddn.com/transform1.gif" alt><br>这两个方法其实是coreAnimation将presentationLayer属性一直保持在动画结束后的状态,而实际的modelLayer属性并没有真正发生改变. 我们如果把customView换成UIButton的话,在动画完成以后点击按钮是不能响应的.点击按钮动画前的位置却能响应!下面是解决办法.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    <span class="comment">//注意: 关于toValue 和 fromValue 设置了这两个值以后presentationLayer的值(也就是动画轨迹)实际上是</span></span><br><span class="line">    <span class="comment">// presentationLayer原始值 -&gt; fromValue -&gt; toValue,动画完成后toValue -&gt; modelLayer的值.</span></span><br><span class="line">    NSLog(@<span class="string">"presentationLayer.position: %@"</span>,NSStringFromCGPoint(_customView.layer.presentationLayer.position));</span><br><span class="line">    NSLog(@<span class="string">"modelLayer.position: %@"</span>,NSStringFromCGPoint(_customView.layer.modelLayer.position));</span><br><span class="line">    _customView.layer.position = CGPointMake(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">    NSLog(@<span class="string">"presentationLayer.position: %@"</span>,NSStringFromCGPoint(_customView.layer.presentationLayer.position));</span><br><span class="line">    NSLog(@<span class="string">"modelLayer.position: %@"</span>,NSStringFromCGPoint(_customView.layer.modelLayer.position));</span><br><span class="line">    <span class="comment">//presentationLayer.position 经历了 (150, 150) -&gt; (150, 150) -&gt; (200, 200) 的过程</span></span><br><span class="line">    CABasicAnimation *animation = [CABasicAnimation animation];</span><br><span class="line">    animation.keyPath = @<span class="string">"position"</span>;</span><br><span class="line">    animation.duration = <span class="number">0.5</span>;</span><br><span class="line">    animation.removedOnCompletion = NO;</span><br><span class="line">    animation.fillMode = kCAFillModeForwards;</span><br><span class="line">    animation.fromValue = [NSValue valueWithCGPoint:CGPointMake(<span class="number">150</span>, <span class="number">150</span>)];</span><br><span class="line">    [_customView.layer addAnimation:animation forKey:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子实际上将<code>animation.fromValue = [NSValue valueWithCGPoint:CGPointMake(150, 150)];</code>这句注释掉也是没问题的,这样既能维持动画完成后状态,view的点击事件不受影响!具体的原理在代码里.<br><img src="http://o7vzr7y09.bkt.clouddn.com/transform1.gif" alt></p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2016/05/02/dispatch-barrier使用详解/">dispatch_barrier使用详解</a><a class="next" href="/2016/02/01/CoreAnimation-CALayer-三/">CoreAnimation-CALayer(三)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yincongxiao.top"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/iOSTips/">iOSTips</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS源码分析/">iOS源码分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/CoreAnimation/" style="font-size: 15px;">CoreAnimation</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/16/Xcode运行python脚本/">Xcode运行python脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/28/Swift4-0/">Swift4.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/18/Https简单复习/">Https简单复习.md</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/23/Toll-Free-Bridging/">Toll-Free Bridging</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/20/YYMemeryCache-study/">YYMemeryCache-study</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/15/YYDiskCache-study/">YYDiskCache study</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/02/GCD-dispatch-source/">GCD-dispatch_source</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/dispatch-group-t-使用详解/">dispatch_group_t 使用详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/02/dispatch-barrier使用详解/">dispatch_barrier使用详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/06/CoreAnimation-CALayer-四/">CoreAnimation-CALayer(四)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">aSnail.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>